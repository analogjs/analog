# Type-Safe Routing Implementation Plan

## Status: ✅ COMPLETE

**Branch:** `feat-typed-routes`  
**Last Updated:** January 2026

### Completed

- [x] Route parser (`packages/platform/src/lib/route-parser.ts`)
- [x] Type generator (`packages/platform/src/lib/type-generator.ts`)
- [x] Vite plugin (`packages/platform/src/lib/typed-routes-plugin.ts`)
- [x] Route builder (`packages/router/src/lib/route-builder.ts`)
- [x] Typed navigation (`packages/router/src/lib/typed-navigation.ts`)
- [x] Inject params (`packages/router/src/lib/inject-params.ts`)
- [x] All unit tests (87 router + 39 platform)
- [x] analog-app updated to use type-safe routing
- [x] Documentation (`apps/docs-app/docs/features/routing/type-safe-routes.md`)

## Overview

Add build-time type generation for Analog's file-based routes, enabling type-safe navigation throughout the application.

## API Surface

| Function                | Purpose                            | Example                                                 |
| ----------------------- | ---------------------------------- | ------------------------------------------------------- |
| `route()`               | Build path string for `routerLink` | `route('/products/[productId]', { productId: 123 })`    |
| `injectNavigate()`      | Inject programmatic navigation fn  | `const navigate = injectNavigate(); navigate('/about')` |
| `injectNavigateByUrl()` | Inject URL navigation fn           | `const nav = injectNavigateByUrl(); nav('/about')`      |
| `injectParams<T>()`     | Consume route params as Signal     | `injectParams<'/products/[productId]'>()`               |

## Configuration

```typescript
// vite.config.ts
import analog from '@analogjs/platform';

export default defineConfig({
  plugins: [
    analog({
      typedRoutes: true, // Enable type generation
    }),
  ],
});
```

## Generated Types

**Location:** `src/app/pages/routes.d.ts` (committed to version control)

```typescript
/**
 * Auto-generated by @analogjs/platform
 * Run `npm run dev` or `npm run build` to regenerate.
 */

import { Signal } from '@angular/core';
import { NavigationExtras, NavigationBehaviorOptions } from '@angular/router';

declare module '@analogjs/router' {
  /** Static routes (no parameters) */
  export type StaticRoutes = '/' | '/about' | '/login' | '/products';

  /** Dynamic route parameter types (for building routes) */
  export interface DynamicRouteParams {
    '/products/[productId]': { productId: string | number };
    '/users/[userId]/posts/[postId]': {
      userId: string | number;
      postId: string | number;
    };
    '/[...not-found]': { 'not-found': string | number };
  }

  /** Resolved parameter types (runtime values are strings) */
  export interface ResolvedRouteParams {
    '/products/[productId]': { productId: string };
    '/users/[userId]/posts/[postId]': { userId: string; postId: string };
    '/[...not-found]': { 'not-found': string };
  }

  /** Dynamic routes */
  export type DynamicRoutes = keyof DynamicRouteParams;

  /** All valid routes */
  export type TypedRoutes = StaticRoutes | DynamicRoutes;

  /** Parameter type for a dynamic route */
  export type RouteParams<T extends DynamicRoutes> = DynamicRouteParams[T];

  /** Resolved parameter type for consuming params */
  export type ResolvedParams<T extends DynamicRoutes> = ResolvedRouteParams[T];

  /** Build a typed route path */
  export function route<T extends StaticRoutes>(path: T): T;
  export function route<T extends DynamicRoutes>(
    path: T,
    params: DynamicRouteParams[T],
  ): string;

  /** Type-safe navigation injection */
  export function injectNavigate(): {
    <T extends StaticRoutes>(
      path: T,
      params?: undefined,
      extras?: NavigationExtras,
    ): Promise<boolean>;
    <T extends DynamicRoutes>(
      path: T,
      params: DynamicRouteParams[T],
      extras?: NavigationExtras,
    ): Promise<boolean>;
  };

  /** Type-safe URL navigation injection */
  export function injectNavigateByUrl(): {
    <T extends StaticRoutes>(
      path: T,
      params?: undefined,
      extras?: NavigationBehaviorOptions,
    ): Promise<boolean>;
    <T extends DynamicRoutes>(
      path: T,
      params: DynamicRouteParams[T],
      extras?: NavigationBehaviorOptions,
    ): Promise<boolean>;
  };

  /** Inject typed route params as a Signal */
  export function injectParams<T extends DynamicRoutes>(): Signal<
    ResolvedRouteParams[T]
  >;
}
```

## Files to Create

### 1. `packages/platform/src/lib/route-parser.ts`

Parses page file paths into route definitions.

```typescript
export interface ParsedRoute {
  filePath: string; // Original file path
  typedPath: string; // /products/[productId]
  params: string[]; // ['productId']
  isStatic: boolean; // No dynamic segments
  isCatchAll: boolean; // Has [...param]
}

export function parseRouteFile(filePath: string): ParsedRoute | null;
export function parseRouteFiles(filePaths: string[]): ParsedRoute[];
```

**Transformation rules:**

| File Path                      | `typedPath`             | `params`        |
| ------------------------------ | ----------------------- | --------------- |
| `(home).page.ts`               | `/`                     | `[]`            |
| `index.page.ts`                | `/`                     | `[]`            |
| `about.page.ts`                | `/about`                | `[]`            |
| `about/team.page.ts`           | `/about/team`           | `[]`            |
| `about.team.page.ts`           | `/about/team`           | `[]`            |
| `products/[productId].page.ts` | `/products/[productId]` | `['productId']` |
| `(auth)/login.page.ts`         | `/login`                | `[]`            |
| `[...not-found].page.ts`       | `/[...not-found]`       | `['not-found']` |

### 2. `packages/platform/src/lib/type-generator.ts`

Generates deterministic TypeScript declaration content.

```typescript
export function generateRouteTypes(routes: ParsedRoute[]): string;
```

- Sorts routes alphabetically for consistent output
- Separates static and dynamic routes
- Generates both `DynamicRouteParams` (for building) and `ResolvedRouteParams` (for consuming)

### 3. `packages/platform/src/lib/typed-routes-plugin.ts`

Vite plugin for type generation with file watching.

```typescript
export function typedRoutesPlugin(options: Options): Plugin[];
```

**Behavior:**

| Event                   | Action           |
| ----------------------- | ---------------- |
| Dev server starts       | Generate types   |
| `.page.ts` file added   | Regenerate types |
| `.page.ts` file deleted | Regenerate types |
| Production build starts | Generate types   |

**Glob pattern:** `${root}/src/app/pages/**/*.page.ts` (excludes `.analog`, `.ag`)

### 4. `packages/router/src/lib/route-builder.ts`

```typescript
export function route(
  path: string,
  params?: Record<string, string | number>,
): string {
  if (!params) return path;

  let result = path;
  for (const [key, value] of Object.entries(params)) {
    result = result
      .replace(`[...${key}]`, String(value))
      .replace(`[${key}]`, String(value));
  }
  return result;
}
```

### 5. `packages/router/src/lib/typed-navigation.ts`

```typescript
import { inject } from '@angular/core';
import {
  Router,
  NavigationExtras,
  NavigationBehaviorOptions,
} from '@angular/router';
import { route } from './route-builder';

/**
 * Type for the navigate function returned by injectNavigate().
 */
export type NavigateFn = <T extends string = string>(
  path: T,
  params?: Record<string, string | number>,
  extras?: NavigationExtras,
) => Promise<boolean>;

/**
 * Type for the navigateByUrl function returned by injectNavigateByUrl().
 */
export type NavigateByUrlFn = <T extends string = string>(
  path: T,
  params?: Record<string, string | number>,
  extras?: NavigationBehaviorOptions,
) => Promise<boolean>;

/**
 * Injects a type-safe navigate function.
 * Must be called within an injection context.
 * Returns a function that can be called anywhere.
 */
export function injectNavigate(): NavigateFn {
  const router = inject(Router);
  return (path, params, extras) => {
    const resolvedPath = params ? route(path, params) : path;
    return router.navigate([resolvedPath], extras);
  };
}

/**
 * Injects a type-safe navigateByUrl function.
 * Must be called within an injection context.
 * Returns a function that can be called anywhere.
 */
export function injectNavigateByUrl(): NavigateByUrlFn {
  const router = inject(Router);
  return (path, params, extras) => {
    const resolvedPath = params ? route(path, params) : path;
    return router.navigateByUrl(resolvedPath, extras);
  };
}
```

### 6. `packages/router/src/lib/inject-params.ts`

```typescript
import { inject, Signal } from '@angular/core';
import { toSignal } from '@angular/core/rxjs-interop';
import { ActivatedRoute } from '@angular/router';
import { map } from 'rxjs';

export function injectParams<T extends Record<string, string>>(): Signal<T> {
  const route = inject(ActivatedRoute);

  return toSignal(
    route.paramMap.pipe(
      map((paramMap) => {
        const params: Record<string, string> = {};
        for (const key of paramMap.keys) {
          params[key] = paramMap.get(key) ?? '';
        }
        return params as T;
      }),
    ),
    { requireSync: true },
  );
}
```

## Files to Modify

### 7. `packages/platform/src/lib/options.ts`

Add new option:

```typescript
export interface Options {
  // ... existing options

  /**
   * Enable type-safe routing.
   * Generates TypeScript types at src/app/pages/routes.d.ts
   * @default false
   */
  typedRoutes?: boolean;
}
```

### 8. `packages/platform/src/lib/platform-plugin.ts`

Import and add plugin:

```typescript
import { typedRoutesPlugin } from './typed-routes-plugin.js';

export function platformPlugin(opts: Options = {}): Plugin[] {
  // ... existing setup

  return [
    ...typedRoutesPlugin(platformOptions), // Add at start
    ...viteNitroPlugin(platformOptions, nitroOptions),
    // ... rest unchanged
  ];
}
```

### 9. `packages/router/src/index.ts`

Export new functions:

```typescript
export { route } from './lib/route-builder';
export {
  injectNavigate,
  injectNavigateByUrl,
  NavigateFn,
  NavigateByUrlFn,
} from './lib/typed-navigation';
export { injectParams } from './lib/inject-params';
```

## File Structure

```
packages/
├── platform/src/lib/
│   ├── route-parser.ts           # NEW
│   ├── type-generator.ts         # NEW
│   ├── typed-routes-plugin.ts    # NEW
│   ├── options.ts                # MODIFY
│   └── platform-plugin.ts        # MODIFY
│
└── router/src/
    ├── lib/
    │   ├── route-builder.ts      # NEW
    │   ├── typed-navigation.ts   # NEW
    │   └── inject-params.ts      # NEW
    └── index.ts                  # MODIFY
```

## Usage Examples

**Template navigation:**

```html
<a [routerLink]="route('/about')">About</a>
<a [routerLink]="route('/products/[productId]', { productId: product.id })">
  {{ product.name }}
</a>
```

**Programmatic navigation:**

```typescript
// Inject navigation functions (in injection context)
private navigate = injectNavigate();
private navigateByUrl = injectNavigateByUrl();

// Use anywhere (event handlers, callbacks, etc.)
// Static route
this.navigateByUrl('/about');

// Dynamic route
this.navigate('/products/[productId]', { productId: '123' });

// With extras
this.navigate(
  '/products/[productId]',
  { productId: '123' },
  {
    queryParams: { ref: 'home' },
  },
);
```

**Consuming params:**

```typescript
@Component({
  template: `<h1>Product {{ params().productId }}</h1>`,
})
export default class ProductPage {
  params = injectParams<'/products/[productId]'>();
}
```

## Key Decisions

| Decision          | Choice                                                        |
| ----------------- | ------------------------------------------------------------- |
| Output location   | `src/app/pages/routes.d.ts`                                   |
| Version control   | Committed                                                     |
| File scope        | `.page.ts` only (no Analog SFCs)                              |
| Catch-all routes  | Included                                                      |
| File watching     | Immediate regeneration (no debounce)                          |
| Param consumption | Signal-based (`injectParams<T>()`)                            |
| Navigation API    | Injection functions (`injectNavigate`, `injectNavigateByUrl`) |
